<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="Yukinoon' s Blog" type="application/atom+xml">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>线程池和多线程工具类 | Yukinoon' s Blog</title>
  </head>
  <body itemscope="" itemtype="http://schema.org/WebPage" lang="zh_CN" data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">Yukinoon' s Blog</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      
      <div class="logo">
        <img src="/images/logo.png" alt="logo">
      </div>
      
    </div>
    <nav id="nav" class="nav">
      <a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a>
      <ul id="menu" role="menubar" aria-hidden="false">
        
        <li role="menuitem"><a href="/">首页</a></li>
        
        <li role="menuitem"><a href="/archives/">归档</a></li>
        
        <li role="menuitem"><a href="/categories/">分类</a></li>
        
        <li role="menuitem"><a href="/tags/">标签</a></li>
        
        <li role="menuitem"><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<div id="post" class="page">
  
  <article class="article post card" itemscope="" itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://www.Yukinoon.com/blog/2019/06/05/线程池和多线程工具类/">
      <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
       <meta itemprop="name" content="John Doe">
       <meta itemprop="description" content="">
       <meta itemprop="image" content="/images/myavatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="Yukinoon' s Blog">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">线程池和多线程工具类</h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2019-06-05T22:28:09+08:00">2019-06-05 22:28:09</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      <p>静态内部类普通同步代码块和静态同步方法所公用的锁对象是 类.class</p>
<p>[TOC]</p>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><h4 id="创建线程的两种传统方式"><a href="#创建线程的两种传统方式" class="headerlink" title="创建线程的两种传统方式"></a>创建线程的两种传统方式</h4><p>建议使用第二种，因为第二种更能体现面向对象的思想</p>
<a id="more"></a>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TraditionalThread</span> </span>&#123;<br><br>	<span class="hljs-comment">/**<br>	 * <span class="hljs-doctag">@param</span> args<br>	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>	<br>		Thread thread = <span class="hljs-keyword">new</span> Thread()&#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">500</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					 &#125;<br>					System.out.println(<span class="hljs-string">"1:"</span> + Thread.currentThread().getName());<br>					System.out.println(<span class="hljs-string">"2:"</span> + <span class="hljs-keyword">this</span>.getName());<br>				&#125;<br>			&#125;<br>		&#125;;<br>		thread.start();<br>		<br>		<br>		Thread thread2 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">500</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>					System.out.println(<span class="hljs-string">"1:"</span> + Thread.currentThread().getName());<br><br>				&#125;				<br>				<br>			&#125;<br>		&#125;);<br>		thread2.start();<br>		<br>		<br>		<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="测试运行的是谁的run-方法"><a href="#测试运行的是谁的run-方法" class="headerlink" title="测试运行的是谁的run()方法"></a>测试运行的是谁的run()方法</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> Thread(<br>				<span class="hljs-keyword">new</span> Runnable()&#123;<br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>						<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>							<span class="hljs-keyword">try</span> &#123;<br>								Thread.sleep(<span class="hljs-number">500</span>);<br>							&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>								e.printStackTrace();<br>							&#125;<br>							System.out.println(<span class="hljs-string">"runnable :"</span> + Thread.currentThread().getName());<br><br>						&#125;							<br>					&#125;<br>				&#125;<br>		)&#123;<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">500</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>					System.out.println(<span class="hljs-string">"thread :"</span> + Thread.currentThread().getName());<br><br>				&#125;	<br>			&#125;<br>		&#125;.start();<br>		<br>		<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>结论：运行的是Thread的run方法，原因是Thread子类若覆盖了父类的run（）方法则执行子类的run（）方法，若没有覆盖父类的run()方法，则寻找target（就是Runnable）的run（）方法。</p>
<h4 id="测试定时器"><a href="#测试定时器" class="headerlink" title="测试定时器"></a>测试定时器</h4><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.Timer;<br><span class="hljs-keyword">import</span> java.util.TimerTask;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TraditionalTimerTest</span> </span>&#123;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//设定10S后爆炸</span><br>		<span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">new</span> TimerTask() &#123;<br>			<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				System.out.println(<span class="hljs-string">"bombing"</span>);<br>			&#125;<br>		&#125;, <span class="hljs-number">10000</span>);<br>		<br>        <span class="hljs-comment">//每秒在控制台打印时间</span><br>		<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>			System.out.println(<span class="hljs-keyword">new</span> Date().getSeconds() );<br>			<span class="hljs-keyword">try</span> &#123;<br>				Thread.sleep(<span class="hljs-number">1000</span>);<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>
<p>新需求：每隔两秒爆炸</p>
<p>错误示范：</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">new</span> TimerTask() &#123;<br>		<br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>			System.out.println(<span class="hljs-string">"bombing"</span>);<br>			<span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">this</span>, <span class="hljs-number">2000</span>);<br>		&#125;<br>	&#125;, <span class="hljs-number">2000</span>);<br></code></pre></td></tr></table></figure>
<p>控制台报错</p>
<figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">Exception in thread &quot;Timer-0&quot; java.lang.IllegalStateException: Task already scheduled or cancelled<br></code></pre></td></tr></table></figure>
<p>原因：任务已经被调度了，不能再次调度（子母弹也是不同的炸弹）。解决方法：将TimerTask定义成一个真正的类，不使用匿名内部类形式。</p>
<p>正确示范:</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTimerTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TimerTask</span></span>&#123;<br>			<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				System.out.println(<span class="hljs-string">"bombing!"</span>);<br>				<span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">new</span> MyTimerTask(), <span class="hljs-number">2000</span>);<br>			&#125;<br>		&#125;<br>		<br>		<br><span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">new</span> MyTimerTask(),<span class="hljs-number">2000</span>);<br></code></pre></td></tr></table></figure>
<p>2秒，4秒间隔爆炸（内部类中不能定义静态变量）</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTimerTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TimerTask</span></span>&#123;<br>			<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				count = (count+<span class="hljs-number">1</span>)%<span class="hljs-number">2</span>;<br>				System.out.println(<span class="hljs-string">"bombing!"</span>);<br>				<span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">new</span> MyTimerTask(),<span class="hljs-number">2000</span>+<span class="hljs-number">2000</span>*count);<br>			&#125;<br>		&#125;<br>		<br>		<span class="hljs-keyword">new</span> Timer().schedule(<span class="hljs-keyword">new</span> MyTimerTask(), <span class="hljs-number">2000</span>);<br></code></pre></td></tr></table></figure>
<h4 id="线程间的互斥和同步通讯"><a href="#线程间的互斥和同步通讯" class="headerlink" title="线程间的互斥和同步通讯"></a>线程间的互斥和同步通讯</h4><p>在外部类的静态方法中不能new 内部类的实例对象</p>
<p>会出现冲突的情况</p>
<h5 id="使用synchronized代码块"><a href="#使用synchronized代码块" class="headerlink" title="使用synchronized代码块"></a>使用synchronized代码块</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TraditionalThreadSynchronized</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">new</span> TraditionalThreadSynchronized().init();<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-keyword">final</span> Outputer outputer = <span class="hljs-keyword">new</span> Outputer();<br>		<br>		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">10</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>					outputer.output(<span class="hljs-string">"zhangxiaoxiang"</span>);<br>				&#125;<br>				<br>			&#125;<br>		&#125;).start();<br>		<br>		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">10</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>					outputer.output(<span class="hljs-string">"huangzhuo"</span>);<br>				&#125;<br>				<br>			&#125;<br>		&#125;).start();<br>	&#125;<br>	<br>	<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Outputer</span> </span>&#123;<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">output</span><span class="hljs-params">(String name)</span></span>&#123;<br>			<span class="hljs-keyword">int</span> len = name.length();<br>			<span class="hljs-keyword">synchronized</span> (Outputer.class) &#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>					System.out.print(name.charAt(i));<br>				&#125;<br>				System.out.println();<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="同步方法"><a href="#同步方法" class="headerlink" title="同步方法"></a>同步方法</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">output2</span><span class="hljs-params">(String name)</span></span>&#123;<br>			<span class="hljs-keyword">int</span> len = name.length();<br>			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>					System.out.print(name.charAt(i));<br>			&#125;<br>			System.out.println();<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="静态同步方法"><a href="#静态同步方法" class="headerlink" title="静态同步方法"></a>静态同步方法</h5><p>静态方法只能写在外部类中，或者静态内部类，内部类加了statiic修饰就相当于外部类</p>
<p>想要output和output3同步，只能把同步代码块的锁由this 改为 “Outputer.class”，静态方法和字节码对象相关联。</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Outputer</span> </span>&#123;<br>       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">output3</span><span class="hljs-params">(String name)</span></span>&#123;<br>                   <span class="hljs-keyword">int</span> len = name.length();<br>                   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>                           System.out.print(name.charAt(i));<br>                   &#125;<br>                   System.out.println();<br>               &#125;	<br>   &#125;<br></code></pre></td></tr></table></figure>
<h4 id="线程等待wait-和唤醒notify"><a href="#线程等待wait-和唤醒notify" class="headerlink" title="线程等待wait()和唤醒notify()"></a>线程等待wait()和唤醒notify()</h4><p>子线程循环10次，接着主线程循环100，接着又回到子线程循环10次，接着再主线程循环100次，如此循环50次    </p>
<p>经验：要用到共同数据（包括同步锁）的若干个方法应该归在同一个类上，这种设计正好体现了高类聚和程序的健壮性。</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TraditionalThreadCommunication</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">final</span> Business business = <span class="hljs-keyword">new</span> Business();<br>		<br>		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>			<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++) &#123;<br>					business.sub(i);<br>				&#125;<br>			&#125;<br>			<br>		&#125;).start();<br>		<br>		<span class="hljs-comment">//main本身也是一个线程</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++) &#123;<br>			business.main(i);<br>		&#125;<br>		<br>	&#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Business</span> </span>&#123;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> bShouldSub = <span class="hljs-keyword">true</span>;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span>  <span class="hljs-title">sub</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>		<span class="hljs-keyword">while</span>(!bShouldSub) &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">//等待</span><br>				<span class="hljs-keyword">this</span>.wait();<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j =<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">10</span>;j++) &#123;<br>			System.out.println(<span class="hljs-string">"子线程循环："</span>+j+<span class="hljs-string">"，"</span>+<span class="hljs-string">"重复第："</span>+i);<br>		&#125;<br>		bShouldSub = <span class="hljs-keyword">false</span>;<br>		<span class="hljs-comment">//唤醒</span><br>		<span class="hljs-keyword">this</span>.notify();<br>		<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span>  <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span> </span>&#123;<br>		<span class="hljs-keyword">while</span>(bShouldSub) &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">//等待</span><br>				<span class="hljs-keyword">this</span>.wait();<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j =<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">100</span>;j++) &#123;<br>			System.out.println(<span class="hljs-string">"主线程循环："</span>+j+<span class="hljs-string">"，"</span>+<span class="hljs-string">"重复第："</span>+i);<br>		&#125;<br>		bShouldSub = <span class="hljs-keyword">true</span>;<br>		<span class="hljs-comment">//唤醒</span><br>		<span class="hljs-keyword">this</span>.notify();<br>		<br>		<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>判断条件，if改为while更好，因为有时候没有被notify()，线程也有可能被唤醒，这种被称之为伪唤醒，使用while可以防止这种伪唤醒的情况。</strong></p>
<h4 id="ThreadLocal实现线程范围内共享变量"><a href="#ThreadLocal实现线程范围内共享变量" class="headerlink" title="ThreadLocal实现线程范围内共享变量"></a>ThreadLocal实现线程范围内共享变量</h4><h5 id="模拟ThreadLocal"><a href="#模拟ThreadLocal" class="headerlink" title="模拟ThreadLocal"></a>模拟ThreadLocal</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadScopeShareData</span> </span>&#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> data = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Thread, Integer&gt; threadMap = <span class="hljs-keyword">new</span> HashMap&lt;Thread, Integer&gt;();<br>	<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span> ; i++ ) &#123;<br>			<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>				<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<span class="hljs-keyword">int</span> data = <span class="hljs-keyword">new</span> Random().nextInt();<br>					System.out.println(Thread.currentThread().getName()+<span class="hljs-string">" has put data :"</span>+data);<br>					threadMap.put(Thread.currentThread(), data);<br>					<span class="hljs-keyword">new</span> A().get();<br>					<span class="hljs-keyword">new</span> B().get();<br>					<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>		<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>			<span class="hljs-keyword">int</span> data = threadMap.get(Thread.currentThread());<br>			System.out.println(<span class="hljs-string">"A from :"</span> + Thread.currentThread().getName()+<span class="hljs-string">" get data :"</span>+data);<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>			<span class="hljs-keyword">int</span> data = threadMap.get(Thread.currentThread());<br>			System.out.println(<span class="hljs-string">"B from :"</span> + Thread.currentThread().getName()+<span class="hljs-string">" get data :"</span>+data);<br>		&#125;<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台</p>
<figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs undefined">Thread-0 has put data :-1260710758<br>Thread-1 has put data :-1606794828<br>A from :Thread-0 get data :-1260710758<br>A from :Thread-1 get data :-1606794828<br>B from :Thread-0 get data :-1260710758<br>B from :Thread-1 get data :-1606794828<br></code></pre></td></tr></table></figure>
<h5 id="改造成ThreadLocal"><a href="#改造成ThreadLocal" class="headerlink" title="改造成ThreadLocal"></a>改造成ThreadLocal</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadLocalTest</span> </span>&#123;<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Integer&gt; x = <span class="hljs-keyword">new</span> ThreadLocal&lt;Integer&gt;();<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span> ; i++ ) &#123;<br>			<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>				<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<span class="hljs-keyword">int</span> data = <span class="hljs-keyword">new</span> Random().nextInt();<br>					System.out.println(Thread.currentThread().getName()+<span class="hljs-string">" has put data :"</span>+data);<br>					x.set(data);<br>					<span class="hljs-keyword">new</span> A().get();<br>					<span class="hljs-keyword">new</span> B().get();<br>					<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>		<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>			<span class="hljs-keyword">int</span> data = x.get();<br>			System.out.println(<span class="hljs-string">"A from :"</span> + Thread.currentThread().getName()+<span class="hljs-string">" get data :"</span>+data);<br>		&#125;<br>		<br>	&#125;<br>	<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>			<span class="hljs-keyword">int</span> data = x.get();<br>			System.out.println(<span class="hljs-string">"B from :"</span> + Thread.currentThread().getName()+<span class="hljs-string">" get data :"</span>+data);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>总结：一个ThreadLocal只能存一个变量，存多个变量就要创建多个ThreadLocal。存多个对象可以定义一个pojo对象，封装起来。</p>
<h5 id="设计单个线程内共享变量"><a href="#设计单个线程内共享变量" class="headerlink" title="设计单个线程内共享变量"></a>设计单个线程内共享变量</h5><p>精髓</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThreadScopeData</span></span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">MyThreadScopeData</span><span class="hljs-params">()</span></span>&#123;&#125;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-comment">/*synchronized*/</span> <span class="hljs-function">MyThreadScopeData <span class="hljs-title">getThreadInstance</span><span class="hljs-params">()</span></span>&#123;<br>		MyThreadScopeData instance = map.get();<br>		<span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>)&#123;<br>			instance = <span class="hljs-keyword">new</span> MyThreadScopeData();<br>			map.set(instance);<br>		&#125;<br>		<span class="hljs-keyword">return</span> instance;<br>	&#125;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;MyThreadScopeData&gt; map = <span class="hljs-keyword">new</span> ThreadLocal&lt;MyThreadScopeData&gt;();<br></code></pre></td></tr></table></figure>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.heima2;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadLocalTest</span> </span>&#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Integer&gt; x = <span class="hljs-keyword">new</span> ThreadLocal&lt;Integer&gt;();<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;MyThreadScopeData&gt; myThreadScopeData = <span class="hljs-keyword">new</span> ThreadLocal&lt;MyThreadScopeData&gt;();<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)&#123;<br>			<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<span class="hljs-keyword">int</span> data = <span class="hljs-keyword">new</span> Random().nextInt();<br>					System.out.println(Thread.currentThread().getName() <br>							+ <span class="hljs-string">" has put data :"</span> + data);<br>					x.set(data);<br>					MyThreadScopeData.getThreadInstance().setName(<span class="hljs-string">"name"</span> + data);<br>					MyThreadScopeData.getThreadInstance().setAge(data);<br>					<span class="hljs-keyword">new</span> A().get();<br>					<span class="hljs-keyword">new</span> B().get();<br>				&#125;<br>			&#125;).start();<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>&#123;<br>			<span class="hljs-keyword">int</span> data = x.get();<br>			System.out.println(<span class="hljs-string">"A from "</span> + Thread.currentThread().getName() <br>					+ <span class="hljs-string">" get data :"</span> + data);<br>			MyThreadScopeData myData = MyThreadScopeData.getThreadInstance();<br>			System.out.println(<span class="hljs-string">"A from "</span> + Thread.currentThread().getName() <br>					+ <span class="hljs-string">" getMyData: "</span> + myData.getName() + <span class="hljs-string">","</span> +<br>					myData.getAge());<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>&#123;<br>			<span class="hljs-keyword">int</span> data = x.get();			<br>			System.out.println(<span class="hljs-string">"B from "</span> + Thread.currentThread().getName() <br>					+ <span class="hljs-string">" get data :"</span> + data);<br>			MyThreadScopeData myData = MyThreadScopeData.getThreadInstance();<br>			System.out.println(<span class="hljs-string">"B from "</span> + Thread.currentThread().getName() <br>					+ <span class="hljs-string">" getMyData: "</span> + myData.getName() + <span class="hljs-string">","</span> +<br>					myData.getAge());			<br>		&#125;		<br>	&#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThreadScopeData</span></span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">MyThreadScopeData</span><span class="hljs-params">()</span></span>&#123;&#125;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-comment">/*synchronized*/</span> <span class="hljs-function">MyThreadScopeData <span class="hljs-title">getThreadInstance</span><span class="hljs-params">()</span></span>&#123;<br>		MyThreadScopeData instance = map.get();<br>		<span class="hljs-keyword">if</span>(instance == <span class="hljs-keyword">null</span>)&#123;<br>			instance = <span class="hljs-keyword">new</span> MyThreadScopeData();<br>			map.set(instance);<br>		&#125;<br>		<span class="hljs-keyword">return</span> instance;<br>	&#125;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;MyThreadScopeData&gt; map = <span class="hljs-keyword">new</span> ThreadLocal&lt;MyThreadScopeData&gt;();<br>	<br>	<span class="hljs-keyword">private</span> String name;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> name;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.name = name;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> age;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>&#123;<br>		<span class="hljs-keyword">this</span>.age = age;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="线程并发库"><a href="#线程并发库" class="headerlink" title="线程并发库"></a>线程并发库</h5><h5 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h5><p>AtomicInteger,AtomicIntegerArray,AtomicIntegerFieldUpdater</p>
<h4 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h4><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.heima2;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPoolTest</span> </span>&#123;<br><br>	<span class="hljs-comment">/**<br>	 * <span class="hljs-doctag">@param</span> args<br>	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><span class="hljs-comment">//		ExecutorService threadPool = Executors.newFixedThreadPool(3);</span><br><span class="hljs-comment">//		ExecutorService threadPool = Executors.newCachedThreadPool();//缓存线程池，线程数量不定</span><br>		ExecutorService threadPool = Executors.newSingleThreadExecutor();<span class="hljs-comment">//只有一个线程的线程池</span><br>		<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i =<span class="hljs-number">0</span> ;i&lt;<span class="hljs-number">6</span>;i++) &#123;<br>			 <span class="hljs-keyword">int</span> task = i;<br>		<br>			threadPool.execute(<span class="hljs-keyword">new</span> Runnable() &#123;<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j =<span class="hljs-number">0</span> ;j&lt;<span class="hljs-number">3</span>;j++) &#123;<br>						<span class="hljs-keyword">try</span> &#123;<br>							Thread.sleep(<span class="hljs-number">20</span>);<br>						&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>							e.printStackTrace();<br>						&#125;<br>						System.out.println(Thread.currentThread().getName()+<span class="hljs-string">" loop of "</span>+j+<span class="hljs-string">" for task of "</span>+ task ) ;<br>					&#125;<br>					<br>				&#125;<br>			&#125;);<br>			<br>		&#125;<br>		<br>		threadPool.shutdown();<br>	<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台</p>
<p>newFixedThreadPool（每次只有三个task被线程拿去服务）</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>
<p>newCachedThreadPool（多少个任务就多少个线程）</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">6</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">6</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">4</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">5</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">6</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<p>newSingleThreadExecutor(如果这个线程死了会重新创建一个出来)</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">0</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">1</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">2</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">3</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">4</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">0</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">1</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br>pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span> loop of <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> task of <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>
<h5 id="用线程池启动定时器"><a href="#用线程池启动定时器" class="headerlink" title="用线程池启动定时器"></a>用线程池启动定时器</h5><p>TimeUnit.SECONDS，定义单位为秒</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Executors.newScheduledThreadPool(<span class="hljs-number">3</span>).schedule(<span class="hljs-keyword">new</span> Runnable() &#123;<br>	<br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>		System.out.println(<span class="hljs-string">"爆炸！！"</span>);<br>	&#125;<br>&#125;, <span class="hljs-number">2</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>
<p>重复运行</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Executors.newScheduledThreadPool(<span class="hljs-number">3</span>).scheduleAtFixedRate(<br>		<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-meta">@Override</span><br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>			System.out.println(<span class="hljs-string">"爆炸！！"</span>);<br>			<br>		&#125;&#125;,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure>
<h4 id="Callable与Future的应用"><a href="#Callable与Future的应用" class="headerlink" title="Callable与Future的应用"></a>Callable与Future的应用</h4><p>Callable</p>
<p>Callable执行可以返回一个结果，可以用future.get()去获取</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.heima2;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.Callable;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutionException;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.Future;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CallableAndFuture</span> </span>&#123;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ExecutorService threadPool = Executors.newSingleThreadExecutor();<br>		Future&lt;String&gt; future = threadPool.submit(<span class="hljs-keyword">new</span> Callable&lt;String&gt;() &#123;<br><br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>;<br>			&#125;<br>			<br>		&#125;);<br>		System.out.println(<span class="hljs-string">"等待结果"</span>);<br>		<span class="hljs-keyword">try</span> &#123;<br>			System.out.println(<span class="hljs-string">"拿到结果："</span>+future.get());<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) &#123;<br>			e.printStackTrace();<br>		&#125;<br>		<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>
<p>提交一组任务</p>
<p> 睡得时间随机，先醒的先获取</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">ExecutorService threadPool2 =  Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>		CompletionService&lt;Integer&gt; completionService = <span class="hljs-keyword">new</span> ExecutorCompletionService&lt;Integer&gt;(threadPool2);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">10</span>;i++)&#123;<br>			<span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> seq = i;<br>			completionService.submit(<span class="hljs-keyword">new</span> Callable&lt;Integer&gt;() &#123;<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                    <span class="hljs-comment">//睡得时间随机，先醒的先获取</span><br>					Thread.sleep(<span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">5000</span>));<br>					<span class="hljs-keyword">return</span> seq;<br>				&#125;<br>			&#125;);<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)&#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				System.out.println(completionService.take().get());<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				e.printStackTrace();<br>			&#125; <span class="hljs-keyword">catch</span> (ExecutionException e) &#123;<br>				e.printStackTrace();<br>			&#125;<br>		&#125;<br></code></pre></td></tr></table></figure>
<h4 id="线程锁技术"><a href="#线程锁技术" class="headerlink" title="线程锁技术"></a>线程锁技术</h4><h5 id="lock"><a href="#lock" class="headerlink" title="lock()"></a>lock()</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockTest</span> </span>&#123;<br><br>	<span class="hljs-comment">/**<br>	 * <span class="hljs-doctag">@param</span> args<br>	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">new</span> LockTest().init();<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>&#123;<br>		<span class="hljs-keyword">final</span> Outputer outputer = <span class="hljs-keyword">new</span> Outputer();<br>		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">10</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						<span class="hljs-comment">// TODO Auto-generated catch block</span><br>						e.printStackTrace();<br>					&#125;<br>					outputer.output(<span class="hljs-string">"zhangxiaoxiang"</span>);<br>				&#125;<br>				<br>			&#125;<br>		&#125;).start();<br>		<br>		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep(<span class="hljs-number">10</span>);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						<span class="hljs-comment">// TODO Auto-generated catch block</span><br>						e.printStackTrace();<br>					&#125;<br>					outputer.output(<span class="hljs-string">"lihuoming"</span>);<br>				&#125;<br>				<br>			&#125;<br>		&#125;).start();<br>		<br>	&#125;<br><br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Outputer</span></span>&#123;<br>		Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">output</span><span class="hljs-params">(String name)</span></span>&#123;<br>			<span class="hljs-keyword">int</span> len = name.length();<br>			lock.lock();<br>			<span class="hljs-keyword">try</span>&#123;<br>				<span class="hljs-comment">//防止执行sys发生中止，出现异常</span><br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>					System.out.print(name.charAt(i));<br>				&#125;<br>				System.out.println();<br>			&#125;<span class="hljs-keyword">finally</span>&#123;<br>				lock.unlock();<br>			&#125;<br>		&#125;<br>		<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h5><p>多个读锁不互斥、写锁和读锁互斥、写锁与写锁互斥</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReadWriteLock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadWriteLockTest</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">final</span> Queue3 q3 = <span class="hljs-keyword">new</span> Queue3();<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++) &#123;<br>			<span class="hljs-keyword">new</span> Thread()&#123;<br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>					<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>						q3.get();						<br>					&#125;<br>				&#125;<br>				<br>			&#125;.start();<br><br>			<span class="hljs-keyword">new</span> Thread()&#123;<br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>					<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>						q3.put(<span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">10000</span>));<br>					&#125;<br>				&#125;			<br>				<br>			&#125;.start();<br>		&#125;<br>		<br>	&#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Queue3</span></span>&#123;<br>	<span class="hljs-keyword">private</span> Object data = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//</span><br>	ReadWriteLock rwl = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>&#123;<br>		rwl.readLock().lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" be ready to read data!"</span>);<br>			Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">1000</span>));<br>			System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"have read data :"</span> + data);			<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			rwl.readLock().unlock();<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(Object data)</span></span>&#123;<br><br>		rwl.writeLock().lock();<br>		<span class="hljs-keyword">try</span> &#123;<br>			System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" be ready to write data!"</span>);					<br>			Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">1000</span>));<br>			<span class="hljs-keyword">this</span>.data = data;		<br>			System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" have write data: "</span> + data);					<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			rwl.writeLock().unlock();<br>		&#125;<br>		<br>	<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="锁降级"><a href="#锁降级" class="headerlink" title="锁降级"></a>锁降级</h5><p>锁降级指的是写锁降级成为读锁。锁降级是指把持住当前拥有的写锁的同时，再获取到读锁，随后释放写锁的过程。以下是oracle官网的对于锁降级的示例代码：</p>
<p>在释放写锁前，去挂读锁，就会把写锁降级为更新锁。</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedData</span> </span>&#123;<br>   Object data;<br>   <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">boolean</span> cacheValid;<br>   <span class="hljs-keyword">final</span> ReentrantReadWriteLock rwl = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br><br>   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processCachedData</span><span class="hljs-params">()</span> </span>&#123;<br>     rwl.readLock().lock();<br>     <span class="hljs-keyword">if</span> (!cacheValid) &#123;<br>        <span class="hljs-comment">// Must release read lock before acquiring write lock</span><br>        rwl.readLock().unlock();<br>        rwl.writeLock().lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// Recheck state because another thread might have</span><br>          <span class="hljs-comment">// acquired write lock and changed state before we did.</span><br>          <span class="hljs-keyword">if</span> (!cacheValid) &#123;<br>            data = ...<br>            cacheValid = <span class="hljs-keyword">true</span>;<br>          &#125;<br>          <span class="hljs-comment">// Downgrade by acquiring read lock before releasing write lock</span><br>          rwl.readLock().lock();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>          rwl.writeLock().unlock(); <span class="hljs-comment">// Unlock write, still hold read</span><br>        &#125;<br>     &#125;<br><br>     <span class="hljs-keyword">try</span> &#123;<br>       use(data);<br>     &#125; <span class="hljs-keyword">finally</span> &#123;<br>       rwl.readLock().unlock();<br>     &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>
<h5 id="设计一个缓存系统"><a href="#设计一个缓存系统" class="headerlink" title="设计一个缓存系统"></a>设计一个缓存系统</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.heima2;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReadWriteLock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheDemo</span> </span>&#123;<br><br>	<span class="hljs-keyword">private</span> Map&lt;String, Object&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>	&#125;<br><br>	<span class="hljs-keyword">private</span> ReadWriteLock rwl = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>	<span class="hljs-function"><span class="hljs-keyword">public</span>  Object <span class="hljs-title">getData</span><span class="hljs-params">(String key)</span></span>&#123;<br>		rwl.readLock().lock();<br>		Object value = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">try</span>&#123;<br>			value = cache.get(key);<br>			<span class="hljs-keyword">if</span>(value == <span class="hljs-keyword">null</span>)&#123;<br>				rwl.readLock().unlock();<br>				rwl.writeLock().lock();<br>				<span class="hljs-keyword">try</span>&#123;<br>					<span class="hljs-keyword">if</span>(value==<span class="hljs-keyword">null</span>)&#123;<br>						value = <span class="hljs-string">"aaaa"</span>;<span class="hljs-comment">//实际失去queryDB();</span><br>					&#125;<br>				&#125;<span class="hljs-keyword">finally</span>&#123;<br>					rwl.writeLock().unlock();<br>				&#125;<br>				rwl.readLock().lock();<br>			&#125;<br>		&#125;<span class="hljs-keyword">finally</span>&#123;<br>			rwl.readLock().unlock();<br>		&#125;<br>		<span class="hljs-keyword">return</span> value;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="Condition条件阻塞"><a href="#Condition条件阻塞" class="headerlink" title="Condition条件阻塞"></a>Condition条件阻塞</h4><p>Condition的功能类似于传统线程技术中的wait和notify功能</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>Condition condition = lock.newCondition();<br>condition.await();<br>condition.signal();<br></code></pre></td></tr></table></figure>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConditionCommunication</span> </span>&#123;<br><br>	<span class="hljs-comment">/**<br>	 * <span class="hljs-doctag">@param</span> args<br>	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">final</span> Business business = <span class="hljs-keyword">new</span> Business();<br>		<span class="hljs-keyword">new</span> Thread(<br>				<span class="hljs-keyword">new</span> Runnable() &#123;<br>					<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<br>						<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>							business.sub(i);<br>						&#125;<br>						<br>					&#125;<br>				&#125;<br>		).start();<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>			business.main(i);<br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Business</span> </span>&#123;<br>			Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>			Condition condition = lock.newCondition();<br>		  <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> bShouldSub = <span class="hljs-keyword">true</span>;<br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">sub</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  lock.lock();<br>			  <span class="hljs-keyword">try</span>&#123;<br>				  <span class="hljs-keyword">while</span>(!bShouldSub)&#123;<br>					  <span class="hljs-keyword">try</span> &#123;<br>						condition.await();<br>					&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>						<span class="hljs-comment">// TODO Auto-generated catch block</span><br>						e.printStackTrace();<br>					&#125;<br>				  &#125;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">10</span>;j++)&#123;<br>						System.out.println(<span class="hljs-string">"sub thread sequence of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>					&#125;<br>				  bShouldSub = <span class="hljs-keyword">false</span>;<br>				  condition.signal();<br>			  &#125;<span class="hljs-keyword">finally</span>&#123;<br>				  lock.unlock();<br>			  &#125;<br>		  &#125;<br>		  <br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  lock.lock();<br>			  <span class="hljs-keyword">try</span>&#123;<br>				 <span class="hljs-keyword">while</span>(bShouldSub)&#123;<br>				  		<span class="hljs-keyword">try</span> &#123;<br>							condition.await();<br>						&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>							<span class="hljs-comment">// TODO Auto-generated catch block</span><br>							e.printStackTrace();<br>						&#125;<br>				  	&#125;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">100</span>;j++)&#123;<br>						System.out.println(<span class="hljs-string">"main thread sequence of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>					&#125;<br>					bShouldSub = <span class="hljs-keyword">true</span>;<br>					condition.signal();<br>		  &#125;<span class="hljs-keyword">finally</span>&#123;<br>			  lock.unlock();<br>		  &#125;<br>	  &#125;<br>	<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="Condition设计阻塞队列"><a href="#Condition设计阻塞队列" class="headerlink" title="Condition设计阻塞队列"></a>Condition设计阻塞队列</h5><p>必须要使用两个Condition，不能使用一个Condition。一个情况，n个线程去取和放，队列只剩一个位置，一个线程放完后只能唤醒取的线程，若只有一个Condition则有可能唤醒放的线程。</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoundedBuffer</span> </span>&#123;<br>   <span class="hljs-keyword">final</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>   <span class="hljs-keyword">final</span> Condition notFull  = lock.newCondition(); <br>   <span class="hljs-keyword">final</span> Condition notEmpty = lock.newCondition(); <br><br>   <span class="hljs-keyword">final</span> Object[] items = <span class="hljs-keyword">new</span> Object[<span class="hljs-number">100</span>];<br>   <span class="hljs-keyword">int</span> putptr, takeptr, count;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(Object x)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>     lock.lock(); <span class="hljs-keyword">try</span> &#123;<br>       <span class="hljs-keyword">while</span> (count == items.length)<br>         notFull.await();<br>       items[putptr] = x;<br>       <span class="hljs-keyword">if</span> (++putptr == items.length) putptr = <span class="hljs-number">0</span>;<br>       ++count;<br>       notEmpty.signal();<br>     &#125; <span class="hljs-keyword">finally</span> &#123; lock.unlock(); &#125;<br>   &#125;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">take</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>     lock.lock(); <span class="hljs-keyword">try</span> &#123;<br>       <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)<br>         notEmpty.await();<br>       Object x = items[takeptr];<br>       <span class="hljs-keyword">if</span> (++takeptr == items.length) takeptr = <span class="hljs-number">0</span>;<br>       --count;<br>       notFull.signal();<br>       <span class="hljs-keyword">return</span> x;<br>     &#125; <span class="hljs-keyword">finally</span> &#123; lock.unlock(); &#125;<br>   &#125;<br> &#125;<br></code></pre></td></tr></table></figure>
<h5 id="三个线程一人执行一次"><a href="#三个线程一人执行一次" class="headerlink" title="三个线程一人执行一次"></a>三个线程一人执行一次</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Condition;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;<br><span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreeConditionCommunication</span> </span>&#123;<br><br>	<span class="hljs-comment">/**<br>	 * <span class="hljs-doctag">@param</span> args<br>	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">final</span> Business business = <span class="hljs-keyword">new</span> Business();<br>		<span class="hljs-keyword">new</span> Thread(<br>				<span class="hljs-keyword">new</span> Runnable() &#123;<br>					<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<br>						<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>							business.sub2(i);<br>						&#125;<br>						<br>					&#125;<br>				&#125;<br>		).start();<br>		<br>		<span class="hljs-keyword">new</span> Thread(<br>				<span class="hljs-keyword">new</span> Runnable() &#123;<br>					<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<br>						<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>							business.sub3(i);<br>						&#125;<br>						<br>					&#125;<br>				&#125;<br>		).start();		<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>			business.main(i);<br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Business</span> </span>&#123;<br>			Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>			Condition condition1 = lock.newCondition();<br>			Condition condition2 = lock.newCondition();<br>			Condition condition3 = lock.newCondition();<br>		  <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> shouldSub = <span class="hljs-number">1</span>;<br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">sub2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  lock.lock();<br>			  <span class="hljs-keyword">try</span>&#123;<br>				  <span class="hljs-keyword">while</span>(shouldSub != <span class="hljs-number">2</span>)&#123;<br>					  <span class="hljs-keyword">try</span> &#123;<br>						condition2.await();<br>					&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				  &#125;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">10</span>;j++)&#123;<br>						System.out.println(<span class="hljs-string">"sub2 thread sequence of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>					&#125;<br>				  shouldSub = <span class="hljs-number">3</span>;<br>				  condition3.signal();<br>			  &#125;<span class="hljs-keyword">finally</span>&#123;<br>				  lock.unlock();<br>			  &#125;<br>		  &#125;<br><br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">sub3</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  lock.lock();<br>			  <span class="hljs-keyword">try</span>&#123;<br>				  <span class="hljs-keyword">while</span>(shouldSub != <span class="hljs-number">3</span>)&#123;<br>					  <span class="hljs-keyword">try</span> &#123;<br>						condition3.await();<br>					&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				  &#125;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">20</span>;j++)&#123;<br>						System.out.println(<span class="hljs-string">"sub3 thread sequence of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>					&#125;<br>				  shouldSub = <span class="hljs-number">1</span>;<br>				  condition1.signal();<br>			  &#125;<span class="hljs-keyword">finally</span>&#123;<br>				  lock.unlock();<br>			  &#125;<br>		  &#125;		  <br>		  <br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  lock.lock();<br>			  <span class="hljs-keyword">try</span>&#123;<br>				 <span class="hljs-keyword">while</span>(shouldSub != <span class="hljs-number">1</span>)&#123;<br>				  		<span class="hljs-keyword">try</span> &#123;<br>							condition1.await();<br>						&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>							e.printStackTrace();<br>						&#125;<br>				  	&#125;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">100</span>;j++)&#123;<br>						System.out.println(<span class="hljs-string">"main thread sequence of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>					&#125;<br>					shouldSub = <span class="hljs-number">2</span>;<br>					condition2.signal();<br>		  &#125;<span class="hljs-keyword">finally</span>&#123;<br>			  lock.unlock();<br>		  &#125;<br>	  &#125;<br>	<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="Samaphore实现信号灯"><a href="#Samaphore实现信号灯" class="headerlink" title="Samaphore实现信号灯"></a>Samaphore实现信号灯</h4><p>类似于食堂吃饭占座</p>
<p>单信号量的Samaphore对象可以实现互斥锁的功能，并且可以是由一个线程获得了“锁”，再由另一个线程释放“锁”，这可以用于死锁恢复的一些场合。</p>
<figure class="hljs highlight JAVA"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.Semaphore;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SemaphoreTest</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ExecutorService service = Executors.newCachedThreadPool();<br>		<span class="hljs-comment">//创建三盏灯</span><br>		<span class="hljs-keyword">final</span>  Semaphore sp = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)&#123;<br>			Runnable runnable = <span class="hljs-keyword">new</span> Runnable()&#123;<br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						<span class="hljs-comment">//获取“一盏灯”</span><br>						sp.acquire();<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e1) &#123;<br>						e1.printStackTrace();<br>					&#125;<br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>							<span class="hljs-string">"进入，当前已有"</span> + (<span class="hljs-number">3</span>-sp.availablePermits()) + <span class="hljs-string">"个并发"</span>);<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>							<span class="hljs-string">"即将离开"</span>);	<br>					<span class="hljs-comment">//释放“一盏灯”</span><br>					sp.release();<br>					<span class="hljs-comment">//下面代码有时候执行不准确，因为其没有和上面的代码合成原子单元</span><br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>							<span class="hljs-string">"已离开，当前已有"</span> + (<span class="hljs-number">3</span>-sp.availablePermits()) + <span class="hljs-string">"个并发"</span>);					<br>				&#125;<br>			&#125;;<br>			service.execute(runnable);	<br>			<br>		&#125;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="CyclicBarrier线程同步工具（类似于旅游集合）"><a href="#CyclicBarrier线程同步工具（类似于旅游集合）" class="headerlink" title="CyclicBarrier线程同步工具（类似于旅游集合）"></a>CyclicBarrier线程同步工具（类似于旅游集合）</h4><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.CyclicBarrier;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CyclicBarrierTest</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ExecutorService service = Executors.newCachedThreadPool();<br>		<span class="hljs-comment">//创建三个集合点</span><br>		<span class="hljs-keyword">final</span>  CyclicBarrier cb = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">3</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)&#123;<br>			Runnable runnable = <span class="hljs-keyword">new</span> Runnable()&#123;<br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));	<br>						System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>								<span class="hljs-string">"即将到达集合地点1，当前已有"</span> + (cb.getNumberWaiting()+<span class="hljs-number">1</span>) + <span class="hljs-string">"个已经到达，"</span> + (cb.getNumberWaiting()==<span class="hljs-number">2</span>?<span class="hljs-string">"都到齐了，继续走啊"</span>:<span class="hljs-string">"正在等候"</span>));						<br>						<span class="hljs-comment">//第一个集合点，等待</span><br>						cb.await();<br>						<br>						Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));	<br>						System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>								<span class="hljs-string">"即将到达集合地点2，当前已有"</span> + (cb.getNumberWaiting()+<span class="hljs-number">1</span>) + <span class="hljs-string">"个已经到达，"</span> + (cb.getNumberWaiting()==<span class="hljs-number">2</span>?<span class="hljs-string">"都到齐了，继续走啊"</span>:<span class="hljs-string">"正在等候"</span>));<br>						<span class="hljs-comment">//第一个集合点，等待</span><br>						cb.await();	<br>						Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));	<br>						System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>								<span class="hljs-string">"即将到达集合地点3，当前已有"</span> + (cb.getNumberWaiting() + <span class="hljs-number">1</span>) + <span class="hljs-string">"个已经到达，"</span> + (cb.getNumberWaiting()==<span class="hljs-number">2</span>?<span class="hljs-string">"都到齐了，继续走啊"</span>:<span class="hljs-string">"正在等候"</span>));						<br>						<span class="hljs-comment">//第一个集合点，等待</span><br>						cb.await();						<br>					&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>						e.printStackTrace();<br>					&#125;				<br>				&#125;<br>			&#125;;<br>			service.execute(runnable);<br>		&#125;<br>		service.shutdown();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>即将到达集合地点<span class="hljs-number">1</span>，当前已有<span class="hljs-number">1</span>个已经到达，正在等候<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>即将到达集合地点<span class="hljs-number">1</span>，当前已有<span class="hljs-number">2</span>个已经到达，正在等候<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>即将到达集合地点<span class="hljs-number">1</span>，当前已有<span class="hljs-number">3</span>个已经到达，都到齐了，继续走啊<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>即将到达集合地点<span class="hljs-number">2</span>，当前已有<span class="hljs-number">1</span>个已经到达，正在等候<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>即将到达集合地点<span class="hljs-number">2</span>，当前已有<span class="hljs-number">2</span>个已经到达，正在等候<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>即将到达集合地点<span class="hljs-number">2</span>，当前已有<span class="hljs-number">3</span>个已经到达，都到齐了，继续走啊<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>即将到达集合地点<span class="hljs-number">3</span>，当前已有<span class="hljs-number">1</span>个已经到达，正在等候<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>即将到达集合地点<span class="hljs-number">3</span>，当前已有<span class="hljs-number">2</span>个已经到达，正在等候<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>即将到达集合地点<span class="hljs-number">3</span>，当前已有<span class="hljs-number">3</span>个已经到达，都到齐了，继续走啊<br></code></pre></td></tr></table></figure>
<h4 id="CountDownLatch（倒数计数器）"><a href="#CountDownLatch（倒数计数器）" class="headerlink" title="CountDownLatch（倒数计数器）"></a>CountDownLatch（倒数计数器）</h4><p>倒数的计数器</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;<br><span class="hljs-keyword">import</span> java.util.concurrent.CyclicBarrier;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountdownLatchTest</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ExecutorService service = Executors.newCachedThreadPool();<br>		<span class="hljs-keyword">final</span> CountDownLatch cdOrder = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">final</span> CountDownLatch cdAnswer = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)&#123;<br>			Runnable runnable = <span class="hljs-keyword">new</span> Runnable()&#123;<br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>								<span class="hljs-string">"正准备接受命令"</span>);						<br>						cdOrder.await();<br>						System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>						<span class="hljs-string">"已接受命令"</span>);								<br>						Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));	<br>						System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>								<span class="hljs-string">"回应命令处理结果"</span>);						<br>						cdAnswer.countDown();						<br>					&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>						e.printStackTrace();<br>					&#125;				<br>				&#125;<br>			&#125;;<br>			service.execute(runnable);<br>		&#125;		<br>		<span class="hljs-keyword">try</span> &#123;<br>			Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));<br>		<br>			System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>					<span class="hljs-string">"即将发布命令"</span>);						<br>			cdOrder.countDown();<br>			System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>			<span class="hljs-string">"已发送命令，正在等待结果"</span>);	<br>			cdAnswer.await();<br>			System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>			<span class="hljs-string">"已收到所有响应结果"</span>);	<br>		&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>			e.printStackTrace();<br>		&#125;				<br>		service.shutdown();<br><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>正准备接受命令<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>正准备接受命令<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>正准备接受命令<br>线程main即将发布命令<br>线程main已发送命令，正在等待结果<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>已接受命令<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>已接受命令<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>已接受命令<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">3</span>回应命令处理结果<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>回应命令处理结果<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>回应命令处理结果<br>线程main已收到所有响应结果<br></code></pre></td></tr></table></figure>
<h4 id="Exchanger（数据交换）"><a href="#Exchanger（数据交换）" class="headerlink" title="Exchanger（数据交换）"></a>Exchanger（数据交换）</h4><p>用于实现两个线程间的数据交换，每一个人在完成一定事务后都想和对方交换数据，第一个先拿出数据的人将一直等待第二个人拿着数据来时，才能交换彼此的数据。</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.Exchanger;<br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExchangerTest</span> </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		ExecutorService service = Executors.newCachedThreadPool();<br>		<span class="hljs-keyword">final</span> Exchanger exchanger = <span class="hljs-keyword">new</span> Exchanger();<br>		service.execute(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">try</span> &#123;				<br><br>					String data1 = <span class="hljs-string">"zxx"</span>;<br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>					<span class="hljs-string">"正在把数据"</span> + data1 +<span class="hljs-string">"换出去"</span>);<br>					Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));<br>					String data2 = (String)exchanger.exchange(data1);<br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>					<span class="hljs-string">"换回的数据为"</span> + data2);<br>				&#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>					<br>				&#125;<br>			&#125;	<br>		&#125;);<br>		service.execute(<span class="hljs-keyword">new</span> Runnable()&#123;<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">try</span> &#123;				<br><br>					String data1 = <span class="hljs-string">"lhm"</span>;<br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>					<span class="hljs-string">"正在把数据"</span> + data1 +<span class="hljs-string">"换出去"</span>);<br>					Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">10000</span>));					<br>					String data2 = (String)exchanger.exchange(data1);<br>					System.out.println(<span class="hljs-string">"线程"</span> + Thread.currentThread().getName() + <br>					<span class="hljs-string">"换回的数据为"</span> + data2);<br>				&#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>					<br>				&#125;				<br>			&#125;	<br>		&#125;);		<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台：</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>正在把数据zxx换出去<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>正在把数据lhm换出去<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">2</span>换回的数据为zxx<br>线程pool-<span class="hljs-number">1</span>-thread-<span class="hljs-number">1</span>换回的数据为lhm<br></code></pre></td></tr></table></figure>
<h4 id="阻塞队列BlockingQueue"><a href="#阻塞队列BlockingQueue" class="headerlink" title="阻塞队列BlockingQueue"></a>阻塞队列BlockingQueue</h4><h5 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h5><p><strong>add</strong>        增加一个元索                     如果队列已满，则抛出一个IIIegaISlabEepeplian异常<br><strong>remove</strong>   移除并返回队列头部的元素    如果队列为空，则抛出一个NoSuchElementException异常<br><strong>element</strong>  返回队列头部的元素             如果队列为空，则抛出一个NoSuchElementException异常<br><strong>offer</strong>       添加一个元素并返回true       如果队列已满，则返回false<br><strong>poll</strong>         移除并返问队列头部的元素    如果队列为空，则返回null<br><strong>peek</strong>       返回队列头部的元素             如果队列为空，则返回null<br><strong>put</strong>         添加一个元素                      如果队列满，则阻塞<br><strong>take</strong>        移除并返回队列头部的元素     如果队列为空，则阻塞</p>
<h5 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h5><p>现在设计两个线程放数据，一个线程取数据</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.ArrayBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockingQueueTest</span> </span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<span class="hljs-keyword">final</span> BlockingQueue queue = <span class="hljs-keyword">new</span> ArrayBlockingQueue(<span class="hljs-number">3</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)&#123;<br>			<span class="hljs-keyword">new</span> Thread()&#123;<br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>					<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>						<span class="hljs-keyword">try</span> &#123;<br>							Thread.sleep((<span class="hljs-keyword">long</span>)(Math.random()*<span class="hljs-number">1000</span>));<br>							System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"准备放数据!"</span>);							<br>							queue.put(<span class="hljs-number">1</span>);<br>							System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"已经放了数据，"</span> + 							<br>										<span class="hljs-string">"队列目前有"</span> + queue.size() + <span class="hljs-string">"个数据"</span>);<br>						&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>							e.printStackTrace();<br>						&#125;<br><br>					&#125;<br>				&#125;<br>				<br>			&#125;.start();<br>		&#125;<br>		<br>		<span class="hljs-keyword">new</span> Thread()&#123;<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>&#123;<br>				<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						<span class="hljs-comment">//将此处的睡眠时间分别改为100和1000，观察运行结果</span><br>						Thread.sleep(<span class="hljs-number">1000</span>);<br>						System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"准备取数据!"</span>);<br>						queue.take();<br>						System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"已经取走数据，"</span> + 							<br>								<span class="hljs-string">"队列目前有"</span> + queue.size() + <span class="hljs-string">"个数据"</span>);					<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						e.printStackTrace();<br>					&#125;<br>				&#125;<br>			&#125;<br>			<br>		&#125;.start();			<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>控制台（中途人为终止）</p>
<figure class="hljs highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs undefined">Thread-1准备放数据!<br>Thread-1已经放了数据，队列目前有1个数据<br>Thread-1准备放数据!<br>Thread-1已经放了数据，队列目前有2个数据<br>Thread-0准备放数据!<br>Thread-0已经放了数据，队列目前有3个数据<br>Thread-2准备取数据!<br>Thread-2已经取走数据，队列目前有2个数据<br>Thread-1准备放数据!<br>Thread-1已经放了数据，队列目前有3个数据<br>Thread-0准备放数据!<br>Thread-2准备取数据!<br>Thread-2已经取走数据，队列目前有2个数据<br>Thread-0已经放了数据，队列目前有3个数据<br>Thread-1准备放数据!<br>Thread-0准备放数据!<br>Thread-2准备取数据!<br>Thread-2已经取走数据，队列目前有2个数据<br>Thread-1已经放了数据，队列目前有3个数据<br></code></pre></td></tr></table></figure>
<h5 id="阻塞队列实现同步通知的功能"><a href="#阻塞队列实现同步通知的功能" class="headerlink" title="阻塞队列实现同步通知的功能"></a>阻塞队列实现同步通知的功能</h5><figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.concurrent.ArrayBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockingQueueCommunication</span> </span>&#123;<br><br>	<span class="hljs-comment">/**<br>	 * <span class="hljs-doctag">@param</span> args<br>	 */</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">final</span> Business business = <span class="hljs-keyword">new</span> Business();<br>		<span class="hljs-keyword">new</span> Thread(<br>				<span class="hljs-keyword">new</span> Runnable() &#123;<br>					<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<br>						<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>							business.sub(i);<br>						&#125;<br>						<br>					&#125;<br>				&#125;<br>		).start();<br>		<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">50</span>;i++)&#123;<br>			business.main(i);<br>		&#125;<br>		<br>	&#125;<br><br>	 <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Business</span> </span>&#123;<br>		 <br>		 <br>		  BlockingQueue&lt;Integer&gt; queue1 = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;Integer&gt;(<span class="hljs-number">1</span>);<br>		  BlockingQueue&lt;Integer&gt; queue2 = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;Integer&gt;(<span class="hljs-number">1</span>);<br>		  <br>		  <span class="hljs-comment">//匿名构造方法，运行时机在任何构造方法之前，new多少个对象就执行多少次</span><br>		  &#123;<br>			  <span class="hljs-keyword">try</span> &#123;<br>				queue2.put(<span class="hljs-number">1</span>);<br>			&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>				<span class="hljs-comment">// TODO Auto-generated catch block</span><br>				e.printStackTrace();<br>			&#125;<br>		  &#125;<br>		  <br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">sub</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  	<span class="hljs-keyword">try</span> &#123;<br>					queue1.put(<span class="hljs-number">1</span>);<br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">10</span>;j++)&#123;<br>					System.out.println(<span class="hljs-string">"sub thread sequece of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>				&#125;<br>				<span class="hljs-keyword">try</span> &#123;<br>					queue2.take();<br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>		  &#125;<br>		  <br>		  <span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>&#123;<br>			  	<span class="hljs-keyword">try</span> &#123;<br>					queue2.put(<span class="hljs-number">1</span>);<br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e1) &#123;<br>					e1.printStackTrace();<br>				&#125;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">100</span>;j++)&#123;<br>					System.out.println(<span class="hljs-string">"main thread sequece of "</span> + j + <span class="hljs-string">",loop of "</span> + i);<br>				&#125;<br>				<span class="hljs-keyword">try</span> &#123;<br>					queue1.take();<br>				&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>					e.printStackTrace();<br>				&#125;<br>		  &#125;<br>	  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h4><h5 id="打印日志"><a href="#打印日志" class="headerlink" title="打印日志"></a>打印日志</h5><p>现有程序代码模拟产生16个日志对象，并且需要运行16秒才能打印完这些日志，请在程序中新增四个线程去调用parseLog()方法分头打印这16个日志对象，程序只要四秒就可以打完这些日志对象。</p>
<p>原始代码</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> read;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;<br>		<br>		System.out.println(<span class="hljs-string">"begin:"</span>+(System.currentTimeMillis()/<span class="hljs-number">1000</span>));<br>		<span class="hljs-comment">/*模拟处理16行日志，下面的代码产生了16个日志对象，当前代码需要运行16秒才能打印完这些日志。<br>		修改程序代码，开四个线程让这16个对象在4秒钟打完。<br>		*/</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">16</span>;i++)&#123;  <span class="hljs-comment">//这行代码不能改动</span><br>			<span class="hljs-keyword">final</span> String log = <span class="hljs-string">""</span>+(i+<span class="hljs-number">1</span>);<span class="hljs-comment">//这行代码不能改动</span><br>			&#123;<br>	     			Test.parseLog(log);<br>			&#125;<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-comment">//parseLog方法内部的代码不能改动</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseLog</span><span class="hljs-params">(String log)</span></span>&#123;<br>		System.out.println(log+<span class="hljs-string">":"</span>+(System.currentTimeMillis()/<span class="hljs-number">1000</span>));<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			Thread.sleep(<span class="hljs-number">1000</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;		<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>
<p>利用阻塞队列</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> read;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ArrayBlockingQueue;<br><span class="hljs-keyword">import</span> java.util.concurrent.BlockingQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;<br>        <span class="hljs-comment">//final BlockingQueue&lt;String&gt; queue = new ArrayBlockingQueue&lt;String&gt;(16);</span><br>        <span class="hljs-keyword">final</span> BlockingQueue&lt;String&gt; queue = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;String&gt;(<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">4</span>;i++)&#123;<br>			<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable()&#123;<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>					<span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>						<span class="hljs-keyword">try</span> &#123;<br>							String log = queue.take();<br>							parseLog(log);<br>						&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>							<span class="hljs-comment">// TODO Auto-generated catch block</span><br>							e.printStackTrace();<br>						&#125;<br>					&#125;<br>				&#125;<br>				<br>			&#125;).start();<br>		&#125;<br>		<br>		System.out.println(<span class="hljs-string">"begin:"</span>+(System.currentTimeMillis()/<span class="hljs-number">1000</span>));<br>		<span class="hljs-comment">/*模拟处理16行日志，下面的代码产生了16个日志对象，当前代码需要运行16秒才能打印完这些日志。<br>		修改程序代码，开四个线程让这16个对象在4秒钟打完。<br>		*/</span><br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">16</span>;i++)&#123;  <span class="hljs-comment">//这行代码不能改动</span><br>			<span class="hljs-keyword">final</span> String log = <span class="hljs-string">""</span>+(i+<span class="hljs-number">1</span>);<span class="hljs-comment">//这行代码不能改动</span><br>			&#123;<br>					<span class="hljs-keyword">try</span> &#123;<br>						queue.put(log);<br>					&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>						<span class="hljs-comment">// TODO Auto-generated catch block</span><br>						e.printStackTrace();<br>					&#125;<br>	     			<span class="hljs-comment">//Test.parseLog(log);</span><br>			&#125;<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-comment">//parseLog方法内部的代码不能改动</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseLog</span><span class="hljs-params">(String log)</span></span>&#123;<br>		System.out.println(log+<span class="hljs-string">":"</span>+(System.currentTimeMillis()/<span class="hljs-number">1000</span>));<br>		<br>		<span class="hljs-keyword">try</span> &#123;<br>			Thread.sleep(<span class="hljs-number">1000</span>);<br>		&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>			e.printStackTrace();<br>		&#125;		<br>	&#125;<br>	<br>&#125;<br></code></pre></td></tr></table></figure>

    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  
  <nav class="page-nav">
    <div class="page-nav-next page-nav-item">
      
      <a href="/2019/06/05/传统多线程知识点/" rel="next" title="传统多线程知识点"><i class="fas fa-angle-left"></i><span class="nav-title">传统多线程知识点</span></a>
      
    </div>
    <div class="page-nav-prev page-nav-item">
      
    </div>
  </nav>
  
  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control">
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/myavatar.png" alt="John Doe">
  
  <h1 class="author-name">John Doe</h1>
  <h2 class="author-description"></h2>
  <div class="site-count">
    
    <div class="archives-count">
      <div class="site-count-title">归档</div>
      <div><a href="/archives/">16</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="categories-count">
      <div class="site-count-title">分类</div>
      <div><a href="/categories/">0</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="tags-count">
      <div class="site-count-title">标签</div>
      <div><a href="/tags/">0</a></div>
    </div>
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    
    
    
    <hr>
    <div class="post-toc sidebar-item" id="toc-div">
      <div><i class="fas fa-list-ol"></i>文章目录</div>
      <div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#多线程"><span class="toc-text">多线程</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#创建线程的两种传统方式"><span class="toc-text">创建线程的两种传统方式</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#测试运行的是谁的run-方法"><span class="toc-text">测试运行的是谁的run()方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#测试定时器"><span class="toc-text">测试定时器</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#线程间的互斥和同步通讯"><span class="toc-text">线程间的互斥和同步通讯</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#使用synchronized代码块"><span class="toc-text">使用synchronized代码块</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#同步方法"><span class="toc-text">同步方法</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#静态同步方法"><span class="toc-text">静态同步方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#线程等待wait-和唤醒notify"><span class="toc-text">线程等待wait()和唤醒notify()</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#ThreadLocal实现线程范围内共享变量"><span class="toc-text">ThreadLocal实现线程范围内共享变量</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#模拟ThreadLocal"><span class="toc-text">模拟ThreadLocal</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#改造成ThreadLocal"><span class="toc-text">改造成ThreadLocal</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#设计单个线程内共享变量"><span class="toc-text">设计单个线程内共享变量</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#线程并发库"><span class="toc-text">线程并发库</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#AtomicInteger"><span class="toc-text">AtomicInteger</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#线程池"><span class="toc-text">线程池</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#用线程池启动定时器"><span class="toc-text">用线程池启动定时器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Callable与Future的应用"><span class="toc-text">Callable与Future的应用</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#线程锁技术"><span class="toc-text">线程锁技术</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#lock"><span class="toc-text">lock()</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#读写锁"><span class="toc-text">读写锁</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#锁降级"><span class="toc-text">锁降级</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#设计一个缓存系统"><span class="toc-text">设计一个缓存系统</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Condition条件阻塞"><span class="toc-text">Condition条件阻塞</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#Condition设计阻塞队列"><span class="toc-text">Condition设计阻塞队列</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#三个线程一人执行一次"><span class="toc-text">三个线程一人执行一次</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Samaphore实现信号灯"><span class="toc-text">Samaphore实现信号灯</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#CyclicBarrier线程同步工具（类似于旅游集合）"><span class="toc-text">CyclicBarrier线程同步工具（类似于旅游集合）</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#CountDownLatch（倒数计数器）"><span class="toc-text">CountDownLatch（倒数计数器）</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#Exchanger（数据交换）"><span class="toc-text">Exchanger（数据交换）</span></a></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#阻塞队列BlockingQueue"><span class="toc-text">阻塞队列BlockingQueue</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#操作方法"><span class="toc-text">操作方法</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#基本使用"><span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#阻塞队列实现同步通知的功能"><span class="toc-text">阻塞队列实现同步通知的功能</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="list-group-item toc-link" href="#面试题"><span class="toc-text">面试题</span></a><ol class="list-group toc-child"><li class="toc-item toc-level-5"><a class="list-group-item toc-link" href="#打印日志"><span class="toc-text">打印日志</span></a></li></ol></li></ol></li></ol></div>
    </div>
    
    
    
    <hr>
    <div class="social-link sidebar-item">
      <div><i class="far fa-address-card"></i>社交链接<p></p></div>
      <ul>
        
        <li><i class="fas fa-envelope"></i><a href="1021782580@qq.com" target="_blank">E-Mail</a></li>
        
        <li><i class="fab fa-github"></i><a href="https://github.com/Yukinoon" target="_blank">GitHub</a></li>
        
        <li><i class="fab fa-weibo"></i><a href="https://weibo.com/u/2301607054?is_all=1" target="_blank">Weibo</a></li>
        
      </ul>
    </div>
    
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">John Doe</span><span class="year"><i class="far fa-copyright"></i>2019</span>
        </div>
        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
