<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    
    <meta name="keywords" content="Life, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="Yukinoon' s Blog" type="application/atom+xml">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-dark.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>SpringCloud学习笔记二 | Yukinoon' s Blog</title>
  </head>
  <body itemscope="" itemtype="http://schema.org/WebPage" lang="zh_CN" data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">Yukinoon' s Blog</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      
      <div class="logo">
        <img src="/images/logo.png" alt="logo">
      </div>
      
    </div>
    <nav id="nav" class="nav">
      <a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a>
      <ul id="menu" role="menubar" aria-hidden="false">
        
        <li role="menuitem"><a href="/">首页</a></li>
        
        <li role="menuitem"><a href="/archives/">归档</a></li>
        
        <li role="menuitem"><a href="/categories/">分类</a></li>
        
        <li role="menuitem"><a href="/tags/">标签</a></li>
        
        <li role="menuitem"><a href="/about/">关于</a></li>
        
      </ul>
    </nav>
  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            
<div id="post" class="page">
  
  <article class="article post card" itemscope="" itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://www.Yukinoon.com/blog/2019/04/16/SpringCloud学习笔记二/">
      <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
       <meta itemprop="name" content="John Doe">
       <meta itemprop="description" content="">
       <meta itemprop="image" content="/images/myavatar.png">
      </span>
      <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
       <meta itemprop="name" content="Yukinoon' s Blog">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">SpringCloud学习笔记二</h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2019-04-16T10:16:36+08:00">2019-04-16 10:16:36</time></span>
        </span>
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      <p>[TOC]</p>
<h3 id="Ribbon是什么"><a href="#Ribbon是什么" class="headerlink" title="Ribbon是什么"></a>Ribbon是什么</h3><p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端    负载均衡的工具。</p>
<h3 id="Ribbon的初步配置"><a href="#Ribbon的初步配置" class="headerlink" title="Ribbon的初步配置"></a>Ribbon的初步配置</h3><p>修改microservicecloud-consumer-dept-80工程</p>
<p>修改pom.xml</p>
<figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Ribbon相关 --&gt;</span><br><span class="hljs-comment">&lt;!-- Ribbon需要和eureka整合 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>修改application.yml，追加eureka的服务注册地址</p>
<figure class="hljs highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">  client:</span><br><span class="hljs-attr">    register-with-eureka:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">    service-url:</span> <br><span class="hljs-attr">      defaultZone:</span> <span class="hljs-attr">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span><br></code></pre></td></tr></table></figure>
<p>ConfigBean.java，加上@LoadBalanced注解</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@LoadBalanced</span><span class="hljs-comment">//Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端       负载均衡的工具。</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">getRestTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>主启动类DeptConsumer80_App.java，添加@EnableEurekaClient</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeptConsumer80_App</span><br></span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span><br>	</span>&#123;<br>		SpringApplication.run(DeptConsumer80_App.class, args);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>修改客户端的访问类，DeptController_Consumer.java</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String REST_URL_PREFIX = <span class="hljs-string">"http://MICROSERVICECLOUD-DEPT"</span>;<br></code></pre></td></tr></table></figure>
<p>先启动三个eureka集群，再启动8001注册进eureka，再启动80</p>
<p>Ribbon和Eureka整合之后可以直接调用服务而不用再关系地址和端口号</p>
<h3 id="Ribbon的负载均衡"><a href="#Ribbon的负载均衡" class="headerlink" title="Ribbon的负载均衡"></a>Ribbon的负载均衡</h3><p>新建microservicecloud-provider-dept-8002，microservicecloud-provider-dept-8003工程，并修改主启动类名，和配置文件，新建8002/8003数据库，各自微服务分别连接各自的数据库，脚本如下</p>
<figure class="hljs highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> cloudDB02;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> cloudDB02 <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> UTF8;<br><span class="hljs-keyword">use</span> cloudDB02;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dept<br>(<br>	deptno <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,<br>	dname <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>),<br>	db_source <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>)<br>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'开发部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'人事部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'财务部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'市场部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'运维部'</span>,<span class="hljs-keyword">DATABASE</span>());<br></code></pre></td></tr></table></figure>
<figure class="hljs highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> cloudDB03;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> cloudDB03 <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> UTF8;<br><span class="hljs-keyword">use</span> cloudDB03;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dept<br>(<br>	deptno <span class="hljs-built_in">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> PRIMARY <span class="hljs-keyword">KEY</span> AUTO_INCREMENT,<br>	dname <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>),<br>	db_source <span class="hljs-built_in">varchar</span>(<span class="hljs-number">60</span>)<br>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'开发部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'人事部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'财务部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'市场部'</span>,<span class="hljs-keyword">DATABASE</span>());<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">into</span> dept(dname,db_source) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'运维部'</span>,<span class="hljs-keyword">DATABASE</span>());<br></code></pre></td></tr></table></figure>
<p>修改各自的yml，端口，数据库必须修改，eureka的instance-id，并对外暴露统一的服务实例名</p>
<figure class="hljs highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">  port:</span> <span class="hljs-number">8002</span><br>  <br><span class="hljs-attr">mybatis:</span><br><span class="hljs-attr">  config-location:</span> <span class="hljs-attr">classpath:mybatis/mybatis.cfg.xml</span>        <span class="hljs-comment"># mybatis配置文件所在路径</span><br><span class="hljs-attr">  type-aliases-package:</span> <span class="hljs-string">com.atguigu.springcloud.entities</span>    <span class="hljs-comment"># 所有Entity别名类所在包</span><br><span class="hljs-attr">  mapper-locations:</span><br><span class="hljs-attr">  - classpath:</span><span class="hljs-string">mybatis/mapper/**/*.xml</span>                       <span class="hljs-comment"># mapper映射文件</span><br>    <br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">   application:</span><br><span class="hljs-attr">    name:</span> <span class="hljs-string">microservicecloud-dept</span> <br><span class="hljs-attr">   datasource:</span><br><span class="hljs-attr">    type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="hljs-comment"># 当前数据源操作类型</span><br><span class="hljs-attr">    driver-class-name:</span> <span class="hljs-string">org.gjt.mm.mysql.Driver</span>              <span class="hljs-comment"># mysql驱动包</span><br><span class="hljs-attr">    url:</span> <span class="hljs-attr">jdbc:mysql://localhost:3306/cloudDB02</span>              <span class="hljs-comment"># 数据库名称</span><br><span class="hljs-attr">    username:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">    password:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">    dbcp2:</span><br><span class="hljs-attr">      min-idle:</span> <span class="hljs-number">5</span>                                           <span class="hljs-comment"># 数据库连接池的最小维持连接数</span><br><span class="hljs-attr">      initial-size:</span> <span class="hljs-number">5</span>                                       <span class="hljs-comment"># 初始化连接数</span><br><span class="hljs-attr">      max-total:</span> <span class="hljs-number">5</span>                                          <span class="hljs-comment"># 最大连接数</span><br><span class="hljs-attr">      max-wait-millis:</span> <span class="hljs-number">200</span>                                  <span class="hljs-comment"># 等待连接获取的最大超时时间</span><br><br><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">  client:</span><br><span class="hljs-attr">    service-url:</span><br>      <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span><br><span class="hljs-attr">      defaultZone:</span> <span class="hljs-attr">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span><br><span class="hljs-attr">  instance:</span><br><span class="hljs-attr">    instance-id:</span> <span class="hljs-string">microservicecloud-dept8002</span><br><span class="hljs-attr">    prefer-ip-address:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment">#访问路径可以显示IP地址  </span><br>    <br><span class="hljs-attr">info:</span> <br>  <span class="hljs-string">app.name:</span> <span class="hljs-string">atguigu-microservicecloud</span><br>  <span class="hljs-string">company.name:</span> <span class="hljs-string">www.atguigu.com</span><br>  <span class="hljs-string">build.artifactId:</span> <span class="hljs-string">$project.artifactId$</span><br>  <span class="hljs-string">build.version:</span> <span class="hljs-string">$project.version$</span><br></code></pre></td></tr></table></figure>
<figure class="hljs highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">  port:</span> <span class="hljs-number">8003</span><br>  <br><span class="hljs-attr">mybatis:</span><br><span class="hljs-attr">  config-location:</span> <span class="hljs-attr">classpath:mybatis/mybatis.cfg.xml</span>        <span class="hljs-comment"># mybatis配置文件所在路径</span><br><span class="hljs-attr">  type-aliases-package:</span> <span class="hljs-string">com.atguigu.springcloud.entities</span>    <span class="hljs-comment"># 所有Entity别名类所在包</span><br><span class="hljs-attr">  mapper-locations:</span><br><span class="hljs-attr">  - classpath:</span><span class="hljs-string">mybatis/mapper/**/*.xml</span>                       <span class="hljs-comment"># mapper映射文件</span><br>    <br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">   application:</span><br><span class="hljs-attr">    name:</span> <span class="hljs-string">microservicecloud-dept</span> <br><span class="hljs-attr">   datasource:</span><br><span class="hljs-attr">    type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="hljs-comment"># 当前数据源操作类型</span><br><span class="hljs-attr">    driver-class-name:</span> <span class="hljs-string">org.gjt.mm.mysql.Driver</span>              <span class="hljs-comment"># mysql驱动包</span><br><span class="hljs-attr">    url:</span> <span class="hljs-attr">jdbc:mysql://localhost:3306/cloudDB03</span>              <span class="hljs-comment"># 数据库名称</span><br><span class="hljs-attr">    username:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">    password:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">    dbcp2:</span><br><span class="hljs-attr">      min-idle:</span> <span class="hljs-number">5</span>                                           <span class="hljs-comment"># 数据库连接池的最小维持连接数</span><br><span class="hljs-attr">      initial-size:</span> <span class="hljs-number">5</span>                                       <span class="hljs-comment"># 初始化连接数</span><br><span class="hljs-attr">      max-total:</span> <span class="hljs-number">5</span>                                          <span class="hljs-comment"># 最大连接数</span><br><span class="hljs-attr">      max-wait-millis:</span> <span class="hljs-number">200</span>                                  <span class="hljs-comment"># 等待连接获取的最大超时时间</span><br><br><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">  client:</span><br><span class="hljs-attr">    service-url:</span><br>      <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span><br><span class="hljs-attr">      defaultZone:</span> <span class="hljs-attr">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span><br><span class="hljs-attr">  instance:</span><br><span class="hljs-attr">    instance-id:</span> <span class="hljs-string">microservicecloud-dept8003</span><br><span class="hljs-attr">    prefer-ip-address:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment">#访问路径可以显示IP地址  </span><br>    <br><span class="hljs-attr">info:</span> <br>  <span class="hljs-string">app.name:</span> <span class="hljs-string">atguigu-microservicecloud</span><br>  <span class="hljs-string">company.name:</span> <span class="hljs-string">www.atguigu.com</span><br>  <span class="hljs-string">build.artifactId:</span> <span class="hljs-string">$project.artifactId$</span><br>  <span class="hljs-string">build.version:</span> <span class="hljs-string">$project.version$</span><br></code></pre></td></tr></table></figure>
<p>启动三个微服务并自测通过，最后启动80</p>
<p><a href="http://localhost:8001/dept/list，http://localhost:8002/dept/list，http://localhost:8003/dept/list" target="_blank" rel="noopener">http://localhost:8001/dept/list，http://localhost:8002/dept/list，http://localhost:8003/dept/list</a></p>
<p>80客户端访问，观察来自哪个微服务（数据库）</p>
<p><a href="http://localhost/consumer/dept/list" target="_blank" rel="noopener">http://localhost/consumer/dept/list</a></p>
<h3 id="Ribbon核心组件IRule"><a href="#Ribbon核心组件IRule" class="headerlink" title="Ribbon核心组件IRule"></a>Ribbon核心组件IRule</h3><p>microservicecloud-consumer-dept-80:</p>
<p>ConfigBean.java</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> IRule <span class="hljs-title">myRule</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RandomRule();<span class="hljs-comment">//目的:用我们重新选择的随机算法替换掉默认的轮询。</span><br>	&#125;<br></code></pre></td></tr></table></figure>
<h3 id="自定义Ribbon的负载均衡策略"><a href="#自定义Ribbon的负载均衡策略" class="headerlink" title="自定义Ribbon的负载均衡策略"></a>自定义Ribbon的负载均衡策略</h3><p>在启动微服务的时候就能去加载我们的自定义Ribbon配置类从而使配置生效。</p>
<p>microservicecloud-consumer-dept-80</p>
<p>DeptConsumer80_App.java</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在启动该微服务的时候就能去加载我们的自定义Ribbon配置类，从而使配置生效</span><br><span class="hljs-meta">@RibbonClient</span>(name=<span class="hljs-string">"MICROSERVICECLOUD-DEPT"</span>,configuration=MySelfRule.class)<br></code></pre></td></tr></table></figure>
<p><strong>警告：</strong></p>
<p><strong>这个自定义配置类不能放在@ComponentScan所扫描的当前包下以及子包下（就是主启动类所在的包）</strong>，否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，也就是说我们达不到特殊化定制的目的了。</p>
<p>新建自定义配置类MySelfRule.java</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.myrule;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-keyword">import</span> com.netflix.loadbalancer.IRule;<br><span class="hljs-keyword">import</span> com.netflix.loadbalancer.RandomRule;<br><br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySelfRule</span> </span>&#123;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> IRule <span class="hljs-title">myRule</span><span class="hljs-params">()</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RandomRule();<span class="hljs-comment">//目的:用我们重新选择的随机算法替换掉默认的轮询。</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>新需求：自定义负载均衡算法，Github上找到RandomRule.java，复制过来修改算法</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.myrule;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> com.netflix.client.config.IClientConfig;<br><span class="hljs-keyword">import</span> com.netflix.loadbalancer.AbstractLoadBalancerRule;<br><span class="hljs-keyword">import</span> com.netflix.loadbalancer.ILoadBalancer;<br><span class="hljs-keyword">import</span> com.netflix.loadbalancer.Server;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomRule_ZY</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLoadBalancerRule</span><br></span>&#123;<br><br>	<span class="hljs-comment">// total = 0 // 当total==5以后，我们指针才能往下走，</span><br>	<span class="hljs-comment">// index = 0 // 当前对外提供服务的服务器地址，</span><br>	<span class="hljs-comment">// total需要重新置为零，但是已经达到过一个5次，我们的index = 1</span><br>	<span class="hljs-comment">// 分析：我们5次，但是微服务只有8001 8002 8003 三台，OK？</span><br>	<span class="hljs-comment">// </span><br>	<br>	<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> total = <span class="hljs-number">0</span>; 			<span class="hljs-comment">// 总共被调用的次数，目前要求每台被调用5次</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> currentIndex = <span class="hljs-number">0</span>;	<span class="hljs-comment">// 当前提供服务的机器号</span><br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Server <span class="hljs-title">choose</span><span class="hljs-params">(ILoadBalancer lb, Object key)</span><br>	</span>&#123;<br>		<span class="hljs-keyword">if</span> (lb == <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>		&#125;<br>		Server server = <span class="hljs-keyword">null</span>;<br><br>		<span class="hljs-keyword">while</span> (server == <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">if</span> (Thread.interrupted()) &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>			&#125;<br>			List&lt;Server&gt; upList = lb.getReachableServers();<br>			List&lt;Server&gt; allList = lb.getAllServers();<br><br>			<span class="hljs-keyword">int</span> serverCount = allList.size();<br>			<span class="hljs-keyword">if</span> (serverCount == <span class="hljs-number">0</span>) &#123;<br>				<span class="hljs-comment">/*<br>				 * No servers. End regardless of pass, because subsequent passes only get more<br>				 * restrictive.<br>				 */</span><br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>			&#125;<br><br><span class="hljs-comment">//			int index = rand.nextInt(serverCount);// java.util.Random().nextInt(3);</span><br><span class="hljs-comment">//			server = upList.get(index);</span><br><br>			<br><span class="hljs-comment">//			private int total = 0; 			// 总共被调用的次数，目前要求每台被调用5次</span><br><span class="hljs-comment">//			private int currentIndex = 0;	// 当前提供服务的机器号</span><br>            <span class="hljs-keyword">if</span>(total &lt; <span class="hljs-number">5</span>)<br>            &#123;<br>	            server = upList.get(currentIndex);<br>	            total++;<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>	            total = <span class="hljs-number">0</span>;<br>	            currentIndex++;<br>	            <span class="hljs-keyword">if</span>(currentIndex &gt;= upList.size())<br>	            &#123;<br>	              currentIndex = <span class="hljs-number">0</span>;<br>	            &#125;<br>            &#125;			<br>			<br>			<br>			<span class="hljs-keyword">if</span> (server == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-comment">/*<br>				 * The only time this should happen is if the server list were somehow trimmed.<br>				 * This is a transient condition. Retry after yielding.<br>				 */</span><br>				Thread.yield();<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br><br>			<span class="hljs-keyword">if</span> (server.isAlive()) &#123;<br>				<span class="hljs-keyword">return</span> (server);<br>			&#125;<br><br>			<span class="hljs-comment">// Shouldn't actually happen.. but must be transient or a bug.</span><br>			server = <span class="hljs-keyword">null</span>;<br>			Thread.yield();<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> server;<br><br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Server <span class="hljs-title">choose</span><span class="hljs-params">(Object key)</span><br>	</span>&#123;<br>		<span class="hljs-keyword">return</span> choose(getLoadBalancer(), key);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initWithNiwsConfig</span><span class="hljs-params">(IClientConfig clientConfig)</span><br>	</span>&#123;<br>		<span class="hljs-comment">// TODO Auto-generated method stub</span><br><br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>原始的算法，RandomRule<br>多线程环境下，用while判断，线程唤醒后还会重新判断一次</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.netflix.loadbalancer;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">import</span> com.netflix.client.config.IClientConfig;<br><br><span class="hljs-comment">/**<br> * A loadbalacing strategy that randomly distributes traffic amongst existing<br> * servers.<br> * <br> * <span class="hljs-doctag">@author</span> stonse<br> * <br> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomRule</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLoadBalancerRule</span> </span>&#123;<br>    Random rand;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RandomRule</span><span class="hljs-params">()</span> </span>&#123;<br>        rand = <span class="hljs-keyword">new</span> Random();<br>    &#125;<br><br>    <span class="hljs-comment">/**<br>     * Randomly choose from all living servers<br>     */</span><br>    <span class="hljs-meta">@edu</span>.umd.cs.findbugs.annotations.SuppressWarnings(value = <span class="hljs-string">"RCN_REDUNDANT_NULLCHECK_OF_NULL_VALUE"</span>)<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Server <span class="hljs-title">choose</span><span class="hljs-params">(ILoadBalancer lb, Object key)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (lb == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>        Server server = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">while</span> (server == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (Thread.interrupted()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>            List&lt;Server&gt; upList = lb.getReachableServers();<br>            List&lt;Server&gt; allList = lb.getAllServers();<br><br>            <span class="hljs-keyword">int</span> serverCount = allList.size();<br>            <span class="hljs-keyword">if</span> (serverCount == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">/*<br>                 * No servers. End regardless of pass, because subsequent passes<br>                 * only get more restrictive.<br>                 */</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">int</span> index = rand.nextInt(serverCount);<span class="hljs-comment">//java.util.Random().nextInt(3);</span><br>            server = upList.get(index);<br><br>            <span class="hljs-keyword">if</span> (server == <span class="hljs-keyword">null</span>) &#123;<br>               <span class="hljs-comment">//线程中断一下</span><br>                Thread.yield();<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (server.isAlive()) &#123;<br>                <span class="hljs-keyword">return</span> (server);<br>            &#125;<br><br>            <span class="hljs-comment">// Shouldn't actually happen.. but must be transient or a bug.</span><br>            server = <span class="hljs-keyword">null</span>;<br>            Thread.yield();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> server;<br><br>    &#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Server <span class="hljs-title">choose</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> choose(getLoadBalancer(), key);<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initWithNiwsConfig</span><span class="hljs-params">(IClientConfig clientConfig)</span> </span>&#123;<br>		<span class="hljs-comment">// TODO Auto-generated method stub</span><br>		<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Feign负载均衡"><a href="#Feign负载均衡" class="headerlink" title="Feign负载均衡"></a>Feign负载均衡</h3><p>Feign是一个声明式的Web服务客户端，使得编写Web客户端变得非常容易，<strong>只需要创建一个接口，然后在上面添加注解即可。</strong></p>
<p>编码：</p>
<p>新建microservicecloud-consumer-dept-feign，将microservicecloud-consumer-dept-80的代码，配置文件复制过来，删除myrule包</p>
<p>1.修改主启动类名字，DeptConsumer80_Feign_App</p>
<p>2.修改pom.xml，添加对Feign的支持</p>
<figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span><br>	<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud-consumer-dept-feign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-comment">&lt;!-- 自己定义的api --&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- feign相关 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- Ribbon相关 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 修改后立即生效，热部署 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springloaded<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>3.修改microservicecloud-api工程</p>
<p>添加Feign相关的支持</p>
<figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span><br>	<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><span class="hljs-comment">&lt;!-- 子类里面显示声明才能有明确的继承表现，无意外就是父类的默认版本否则自己定义 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><span class="hljs-comment">&lt;!-- 当前Module我自己叫什么名字 --&gt;</span><br><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><span class="hljs-comment">&lt;!-- 当前Module需要用到的jar包，按自己需求添加，如果父类已经包含了，可以不用写版本号 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- feign相关 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-feign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>4.新建接口DeptClientService.java，并增加注解@FeignClient</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.feign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><br><span class="hljs-keyword">import</span> com.atguigu.springcloud.entities.Dept;<br><br><br><span class="hljs-comment">/**<br> * <br> * <span class="hljs-doctag">@Description</span>: 修改microservicecloud-api工程，根据已经有的DeptClientService接口<br> * <span class="hljs-doctag">@author</span> zzyy<br> * <span class="hljs-doctag">@date</span> 2018年4月21日<br> */</span><br><span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"MICROSERVICECLOUD-DEPT"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DeptClientService</span><br></span>&#123;<br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/get/&#123;id&#125;"</span>, method = RequestMethod.GET)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Dept <span class="hljs-title">get</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">long</span> id)</span>;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/list"</span>, method = RequestMethod.GET)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Dept&gt; <span class="hljs-title">list</span><span class="hljs-params">()</span></span>;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/add"</span>, method = RequestMethod.POST)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(Dept dept)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>5.将microservicecloud-api执行maven-clean，maven-install操作</p>
<p>6.修改microservicecloud-consumer-dept-feignd额Controller，添加上一步新建的DeptClientService接口</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.controller;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> com.atguigu.springcloud.entities.Dept;<br><span class="hljs-keyword">import</span> com.atguigu.springcloud.service.DeptClientService;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeptController_Consumer</span><br></span>&#123;<br><br>	<span class="hljs-meta">@Autowired</span><br>	<span class="hljs-keyword">private</span> DeptClientService service;<br>	<br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/consumer/dept/get/&#123;id&#125;"</span>)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Dept <span class="hljs-title">get</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)<br>	</span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.service.get(id);<br>	&#125;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/consumer/dept/list"</span>)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Dept&gt; <span class="hljs-title">list</span><span class="hljs-params">()</span><br>	</span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.service.list();<br>	&#125;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/consumer/dept/add"</span>)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">add</span><span class="hljs-params">(Dept dept)</span><br>	</span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.service.add(dept);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>7.修改microservicecloud-consumer-dept-feign主启动类，加上@EnableFeignClients</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.feign.EnableFeignClients;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients</span>(basePackages= &#123;<span class="hljs-string">"com.atguigu.springcloud"</span>&#125;)<br><span class="hljs-meta">@ComponentScan</span>(<span class="hljs-string">"com.atguigu.springcloud"</span>)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeptConsumer80_Feign_App</span><br></span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span><br>	</span>&#123;<br>		SpringApplication.run(DeptConsumer80_Feign_App.class, args);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="Hystrix断路器-服务熔断"><a href="#Hystrix断路器-服务熔断" class="headerlink" title="Hystrix断路器-服务熔断"></a>Hystrix断路器-服务熔断</h3><p>​    由于网络或程序自躾 的原因，服务并不能保证百分百可靠可用，如果单个服务出现问题，调用这个服务就出现线程阻塞，此时若有大量的请求涌入，servlet容器的线程资源就会被消耗完毕导致服务瘫痪。服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成不可估量的严重后果，这就是常说的服务故障的“雪崩效应”。为了解决这个问题，有人就提出了一种解决问题的思路，断路器模型。就是每一个调用服务的接口处加一个断路器，默认是关闭的，当对服务调用时，不可用的次数达到一个阀值时，断路器就会打开，通过回调方法迅速返回一个值结束调用，避免出现连锁故障，注解为@HystrixCommand</p>
<p>1.参考microservicecloud-provider-dept-8001，新建microservicecloud-provider-dept-hystrix-8001</p>
<p>pom.xml，新增，修改内容</p>
<figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- hystrix --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="hljs highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud-provider-dept-hystrix-8001<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 引入自己定义的api通用包，可以使用Dept部门Entity --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>microservicecloud-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- hystrix --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- actuator监控信息完善 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>		    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 将微服务provider侧注册进eureka --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>		    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>		    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>		    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-comment">&lt;!-- 修改后立即生效，热部署 --&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springloaded<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>		<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>2.修改application.yml，仅仅修改了instance.instance-id:</p>
<figure class="hljs highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">  port:</span> <span class="hljs-number">8001</span><br>  <br><span class="hljs-attr">mybatis:</span><br><span class="hljs-attr">  config-location:</span> <span class="hljs-attr">classpath:mybatis/mybatis.cfg.xml</span>        <span class="hljs-comment"># mybatis配置文件所在路径</span><br><span class="hljs-attr">  type-aliases-package:</span> <span class="hljs-string">com.atguigu.springcloud.entities</span>    <span class="hljs-comment"># 所有Entity别名类所在包</span><br><span class="hljs-attr">  mapper-locations:</span><br><span class="hljs-attr">  - classpath:</span><span class="hljs-string">mybatis/mapper/**/*.xml</span>                       <span class="hljs-comment"># mapper映射文件</span><br>    <br><span class="hljs-attr">spring:</span><br><span class="hljs-attr">   application:</span><br><span class="hljs-attr">    name:</span> <span class="hljs-string">microservicecloud-dept</span> <br><span class="hljs-attr">   datasource:</span><br><span class="hljs-attr">    type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>            <span class="hljs-comment"># 当前数据源操作类型</span><br><span class="hljs-attr">    driver-class-name:</span> <span class="hljs-string">org.gjt.mm.mysql.Driver</span>              <span class="hljs-comment"># mysql驱动包</span><br><span class="hljs-attr">    url:</span> <span class="hljs-attr">jdbc:mysql://localhost:3306/cloudDB01</span>              <span class="hljs-comment"># 数据库名称</span><br><span class="hljs-attr">    username:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">    password:</span> <span class="hljs-string">root</span><br><span class="hljs-attr">    dbcp2:</span><br><span class="hljs-attr">      min-idle:</span> <span class="hljs-number">5</span>                                           <span class="hljs-comment"># 数据库连接池的最小维持连接数</span><br><span class="hljs-attr">      initial-size:</span> <span class="hljs-number">5</span>                                       <span class="hljs-comment"># 初始化连接数</span><br><span class="hljs-attr">      max-total:</span> <span class="hljs-number">5</span>                                          <span class="hljs-comment"># 最大连接数</span><br><span class="hljs-attr">      max-wait-millis:</span> <span class="hljs-number">200</span>                                  <span class="hljs-comment"># 等待连接获取的最大超时时间</span><br><br><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">  client:</span><br><span class="hljs-attr">    service-url:</span><br>      <span class="hljs-comment">#defaultZone: http://localhost:7001/eureka</span><br><span class="hljs-attr">      defaultZone:</span> <span class="hljs-attr">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span><br><span class="hljs-attr">  instance:</span><br><span class="hljs-attr">    instance-id:</span> <span class="hljs-string">microservicecloud-dept8001-hystrix</span>   <span class="hljs-comment">#自定义hystrix相关的服务名称信息</span><br><span class="hljs-attr">    prefer-ip-address:</span> <span class="hljs-literal">true</span>     <span class="hljs-comment">#访问路径可以显示IP地址  </span><br>    <br><span class="hljs-attr">info:</span> <br>  <span class="hljs-string">app.name:</span> <span class="hljs-string">atguigu-microservicecloud</span><br>  <span class="hljs-string">company.name:</span> <span class="hljs-string">www.atguigu.com</span><br>  <span class="hljs-string">build.artifactId:</span> <span class="hljs-string">$project.artifactId$</span><br>  <span class="hljs-string">build.version:</span> <span class="hljs-string">$project.version$</span><br></code></pre></td></tr></table></figure>
<p>3.修改DeptController</p>
<p>@HystrixCommand报异常后如何处理</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> com.atguigu.springcloud.entities.Dept;<br><span class="hljs-keyword">import</span> com.atguigu.springcloud.service.DeptService;<br><span class="hljs-keyword">import</span> com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;<br><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeptController</span><br></span>&#123;<br>	<span class="hljs-meta">@Autowired</span><br>	<span class="hljs-keyword">private</span> DeptService service = <span class="hljs-keyword">null</span>;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/get/&#123;id&#125;"</span>, method = RequestMethod.GET)<br>	<span class="hljs-comment">//一旦调用服务方法失败并抛出了错误信息后，会自动调用@HystrixCommand标注好的fallbackMethod调用类中的指定方法</span><br>	<span class="hljs-meta">@HystrixCommand</span>(fallbackMethod = <span class="hljs-string">"processHystrix_Get"</span>)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Dept <span class="hljs-title">get</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)<br>	</span>&#123;<br><br>		Dept dept = <span class="hljs-keyword">this</span>.service.get(id);<br>		<br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == dept) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"该ID："</span> + id + <span class="hljs-string">"没有没有对应的信息"</span>);<br>		&#125;<br>		<br>		<span class="hljs-keyword">return</span> dept;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Dept <span class="hljs-title">processHystrix_Get</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> Long id)<br>	</span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Dept().setDeptno(id).setDname(<span class="hljs-string">"该ID："</span> + id + <span class="hljs-string">"没有没有对应的信息,null--@HystrixCommand"</span>)<br>				.setDb_source(<span class="hljs-string">"no this database in MySQL"</span>);<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>修改主启动类DeptProvider8001_Hystrix_App.java，添加注解@EnableCircuitBreake</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;<br><span class="hljs-keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;<br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span> <span class="hljs-comment">//本服务启动后会自动注册进eureka服务中</span><br><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">//服务发现</span><br><span class="hljs-meta">@EnableCircuitBreaker</span><span class="hljs-comment">//对hystrixR熔断机制的支持</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeptProvider8001_Hystrix_App</span><br></span>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span><br>	</span>&#123;<br>		SpringApplication.run(DeptProvider8001_Hystrix_App.class, args);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测试：先启动三个注册中心eureka，再启动microservicecloud-consumer-dept-80，测试地址：<a href="http://localhost/consumer/dept/get/112" target="_blank" rel="noopener">http://localhost/consumer/dept/get/112</a></p>
<h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><p>整体资源快不够了，忍痛将某些服务先关掉，待渡过难关，再开启回来</p>
<p>服务端的降级处理，是在客户端实现完成的，与服务端没有关系</p>
<p>修改microservicecloud-api工程，根据已有的DeptClientService接口新建一个实现了FallbackFactory接口的类</p>
<p>DeptClientServiceFallbackFactory，千万不要忘记在类上新增@Component注解，大坑！！！</p>
<p>DeptClientServiceFallbackFactory.java</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> com.atguigu.springcloud.entities.Dept;<br><span class="hljs-keyword">import</span> feign.hystrix.FallbackFactory;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeptClientServiceFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FallbackFactory</span>&lt;<span class="hljs-title">DeptClientService</span>&gt; </span>&#123;<br><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> DeptClientService <span class="hljs-title">create</span><span class="hljs-params">(Throwable cause)</span> </span>&#123;<br>		<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DeptClientService() &#123;<br>			<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Dept&gt; <span class="hljs-title">list</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>			&#125;<br>			<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> Dept <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">long</span> id)</span> </span>&#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Dept().setDeptno(id).setDname(<span class="hljs-string">"该ID："</span> + id + <span class="hljs-string">"没有没有对应的信息,Consumer客户端提供的降级信息,此刻服务Provider已经关闭"</span>)<br>						.setDb_source(<span class="hljs-string">"no this database in MySQL"</span>);<br>			&#125;<br>			<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(Dept dept)</span> </span>&#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>			&#125;<br>		&#125;;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>修改microservicecloud-api，DeptClientService接口，在注解@FeignClient中添加fallbackFactory属性值</p>
<figure class="hljs highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.springcloud.service;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> org.springframework.cloud.netflix.feign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;<br><span class="hljs-keyword">import</span> com.atguigu.springcloud.entities.Dept;<br><br><br><span class="hljs-comment">/**<br> * <br> * <span class="hljs-doctag">@Description</span>: 修改microservicecloud-api工程，根据已经有的DeptClientService接口<br> * <span class="hljs-doctag">@author</span> zzyy<br> * <span class="hljs-doctag">@date</span> 2018年4月21日<br> */</span><br><span class="hljs-comment">//@FeignClient(value = "MICROSERVICECLOUD-DEPT")</span><br><span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"MICROSERVICECLOUD-DEPT"</span>,fallbackFactory=DeptClientServiceFallbackFactory.class)<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DeptClientService</span><br></span>&#123;<br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/get/&#123;id&#125;"</span>, method = RequestMethod.GET)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Dept <span class="hljs-title">get</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> <span class="hljs-keyword">long</span> id)</span>;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/list"</span>, method = RequestMethod.GET)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Dept&gt; <span class="hljs-title">list</span><span class="hljs-params">()</span></span>;<br><br>	<span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/dept/add"</span>, method = RequestMethod.POST)<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(Dept dept)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>microservicecloud-api执行，clean，install</p>
<p>microservicecloud-consumer-dept-feign修改appilicatiom.yml</p>
<figure class="hljs highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span> <br><span class="hljs-attr">  hystrix:</span> <br><span class="hljs-attr">    enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>
<figure class="hljs highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br><span class="hljs-attr">  port:</span> <span class="hljs-number">80</span><br>  <br><span class="hljs-attr">feign:</span> <br><span class="hljs-attr">  hystrix:</span> <br><span class="hljs-attr">    enabled:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">eureka:</span><br><span class="hljs-attr">  client:</span><br><span class="hljs-attr">    register-with-eureka:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">    service-url:</span> <br><span class="hljs-attr">      defaultZone:</span> <span class="hljs-attr">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/,http://eureka7003.com:7003/eureka/</span><br></code></pre></td></tr></table></figure>
<p>测试，启动三个注册中心，启动microservicecloud-provider-dept-8001，启动microservicecloud-consumer-dept-feign，先正常测试，然后故意关闭8001，查看结果。</p>

    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  
  <nav class="page-nav">
    <div class="page-nav-next page-nav-item">
      
      <a href="/2019/04/16/SpringCloud学习笔记/" rel="next" title=""><i class="fas fa-angle-left"></i><span class="nav-title"></span></a>
      
    </div>
    <div class="page-nav-prev page-nav-item">
      
      <a href="/2019/04/16/SpringCloud学习笔记三/" rel="prev" title="SpringCloud学习笔记三"><span class="nav-title">SpringCloud学习笔记三</span><i class="fas fa-angle-right"></i></a>
      
    </div>
  </nav>
  
  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control">
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/myavatar.png" alt="John Doe">
  
  <h1 class="author-name">John Doe</h1>
  <h2 class="author-description"></h2>
  <div class="site-count">
    
    <div class="archives-count">
      <div class="site-count-title">归档</div>
      <div><a href="/archives/">11</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="categories-count">
      <div class="site-count-title">分类</div>
      <div><a href="/categories/">0</a></div>
    </div>
    
    
    
    <span class="site-count-divider divider">|</span>
    
    <div class="tags-count">
      <div class="site-count-title">标签</div>
      <div><a href="/tags/">0</a></div>
    </div>
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    
    
    
    <hr>
    <div class="post-toc sidebar-item" id="toc-div">
      <div><i class="fas fa-list-ol"></i>文章目录</div>
      <div class="post-toc-content"><ol class="list-group toc"><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Ribbon是什么"><span class="toc-text">Ribbon是什么</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Ribbon的初步配置"><span class="toc-text">Ribbon的初步配置</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Ribbon的负载均衡"><span class="toc-text">Ribbon的负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Ribbon核心组件IRule"><span class="toc-text">Ribbon核心组件IRule</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#自定义Ribbon的负载均衡策略"><span class="toc-text">自定义Ribbon的负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Feign负载均衡"><span class="toc-text">Feign负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#Hystrix断路器-服务熔断"><span class="toc-text">Hystrix断路器-服务熔断</span></a></li><li class="toc-item toc-level-3"><a class="list-group-item toc-link" href="#服务降级"><span class="toc-text">服务降级</span></a></li></ol></div>
    </div>
    
    
    
    <hr>
    <div class="social-link sidebar-item">
      <div><i class="far fa-address-card"></i>社交链接<p></p></div>
      <ul>
        
        <li><i class="fas fa-envelope"></i><a href="1021782580@qq.com" target="_blank">E-Mail</a></li>
        
        <li><i class="fab fa-github"></i><a href="https://github.com/Yukinoon" target="_blank">GitHub</a></li>
        
        <li><i class="fab fa-weibo"></i><a href="https://weibo.com/u/2301607054?is_all=1" target="_blank">Weibo</a></li>
        
      </ul>
    </div>
    
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">John Doe</span><span class="year"><i class="far fa-copyright"></i>2019</span>
        </div>
        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  </body>
</html>
